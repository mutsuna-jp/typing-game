// Shared Kana engine and CSV parsing utilities for server and client
export type KanaTable = Record<string, string[]>;
export type Word = { disp: string; kana: string };

export const GAME_CONFIG = {
  BASE_SCORE_PER_CHAR: 5,
  COMBO_MULTIPLIER: 0.05,
  PERFECT_SCORE_BONUS: 20,
  DEFAULT_TIME: 60,
  MAX_TIME: 90,
};

// 濁音・半濁音から基本文字へのマッピング
export const voicedMap: Record<string, string> = {
  が: "か",
  ぎ: "き",
  ぐ: "く",
  げ: "け",
  ご: "こ",
  ぱ: "は",
  ぴ: "ひ",
  ぷ: "ふ",
  ぺ: "へ",
  ぽ: "ほ",
  ざ: "さ",
  じ: "し",
  ず: "す",
  ぜ: "せ",
  ぞ: "そ",
  だ: "た",
  ぢ: "ち",
  づ: "つ",
  で: "て",
  ど: "と",
  ば: "は",
  び: "ひ",
  ぶ: "ふ",
  べ: "へ",
  ぼ: "ほ",
  ゔ: "う",
};

// 清音から濁音へのマッピング（段階的な濁音化パターンに対応）
// 例：た（入力）→ だ（中間）→ ど（目標）
export const clearToVoicedMap: Record<string, string> = {
  // か行 → が行
  か: "が",
  き: "ぎ",
  く: "ぐ",
  け: "げ",
  こ: "ご",
  // さ行 → ざ行
  さ: "ざ",
  し: "じ",
  す: "ず",
  せ: "ぜ",
  そ: "ぞ",
  // た行 → だ行
  た: "だ",
  ち: "ぢ",
  つ: "づ",
  て: "で",
  と: "ど",
  // は行 → ば行
  は: "ば",
  ひ: "び",
  ふ: "ぶ",
  へ: "べ",
  ほ: "ぼ",
};

// 濁音から半濁音へのマッピング（ば行→ぱ行の中間状態）
export const voicedToSemiMap: Record<string, string> = {
  ば: "ぱ",
  び: "ぴ",
  ぶ: "ぷ",
  べ: "ぺ",
  ぼ: "ぽ",
};

// 半濁音から対応する濁音へのマッピング（フリック変換の中間状態）
// 注：voicedToSemiMapの逆方向。半濁音（ぱゃ）→濁音（びゃ）の中間状態を定義
export const semiToVoiced: Record<string, string> = {
  ぱ: "ば",
  ぴ: "び",
  ぷ: "ぶ",
  ぺ: "べ",
  ぽ: "ぼ",
};

// ATOKフラワーフリック入力：同行内の中間状態を許容
// 例：目標が「ち」で入力が「た」の場合、フリック行の中間状態として許容する
export const atokFlickRowMap: Record<string, string[]> = {
  // あ行
  あ: ["あ", "い", "う", "え", "お"],
  い: ["あ", "い", "う", "え", "お"],
  う: ["あ", "い", "う", "え", "お"],
  え: ["あ", "い", "う", "え", "お"],
  お: ["あ", "い", "う", "え", "お"],
  // か行
  か: ["か", "き", "く", "け", "こ"],
  き: ["か", "き", "く", "け", "こ"],
  く: ["か", "き", "く", "け", "こ"],
  け: ["か", "き", "く", "け", "こ"],
  こ: ["か", "き", "く", "け", "こ"],
  // が行
  が: ["が", "ぎ", "ぐ", "げ", "ご"],
  ぎ: ["が", "ぎ", "ぐ", "げ", "ご"],
  ぐ: ["が", "ぎ", "ぐ", "げ", "ご"],
  げ: ["が", "ぎ", "ぐ", "げ", "ご"],
  ご: ["が", "ぎ", "ぐ", "げ", "ご"],
  // さ行
  さ: ["さ", "し", "す", "せ", "そ"],
  し: ["さ", "し", "す", "せ", "そ"],
  す: ["さ", "し", "す", "せ", "そ"],
  せ: ["さ", "し", "す", "せ", "そ"],
  そ: ["さ", "し", "す", "せ", "そ"],
  // ざ行
  ざ: ["ざ", "じ", "ず", "ぜ", "ぞ"],
  じ: ["ざ", "じ", "ず", "ぜ", "ぞ"],
  ず: ["ざ", "じ", "ず", "ぜ", "ぞ"],
  ぜ: ["ざ", "じ", "ず", "ぜ", "ぞ"],
  ぞ: ["ざ", "じ", "ず", "ぜ", "ぞ"],
  // た行
  た: ["た", "ち", "つ", "て", "と"],
  ち: ["た", "ち", "つ", "て", "と"],
  つ: ["た", "ち", "つ", "て", "と"],
  て: ["た", "ち", "つ", "て", "と"],
  と: ["た", "ち", "つ", "て", "と"],
  // だ行
  だ: ["だ", "ぢ", "づ", "で", "ど"],
  ぢ: ["だ", "ぢ", "づ", "で", "ど"],
  づ: ["だ", "ぢ", "づ", "で", "ど"],
  で: ["だ", "ぢ", "づ", "で", "ど"],
  ど: ["だ", "ぢ", "づ", "で", "ど"],
  // な行
  な: ["な", "に", "ぬ", "ね", "の"],
  に: ["な", "に", "ぬ", "ね", "の"],
  ぬ: ["な", "に", "ぬ", "ね", "の"],
  ね: ["な", "に", "ぬ", "ね", "の"],
  の: ["な", "に", "ぬ", "ね", "の"],
  // は行
  は: ["は", "ひ", "ふ", "へ", "ほ"],
  ひ: ["は", "ひ", "ふ", "へ", "ほ"],
  ふ: ["は", "ひ", "ふ", "へ", "ほ"],
  へ: ["は", "ひ", "ふ", "へ", "ほ"],
  ほ: ["は", "ひ", "ふ", "へ", "ほ"],
  // ば行
  ば: ["ば", "び", "ぶ", "べ", "ぼ"],
  び: ["ば", "び", "ぶ", "べ", "ぼ"],
  ぶ: ["ば", "び", "ぶ", "べ", "ぼ"],
  べ: ["ば", "び", "ぶ", "べ", "ぼ"],
  ぼ: ["ば", "び", "ぶ", "べ", "ぼ"],
  // ぱ行
  ぱ: ["ぱ", "ぴ", "ぷ", "ぺ", "ぽ"],
  ぴ: ["ぱ", "ぴ", "ぷ", "ぺ", "ぽ"],
  ぷ: ["ぱ", "ぴ", "ぷ", "ぺ", "ぽ"],
  ぺ: ["ぱ", "ぴ", "ぷ", "ぺ", "ぽ"],
  ぽ: ["ぱ", "ぴ", "ぷ", "ぺ", "ぽ"],
  // ま行
  ま: ["ま", "み", "む", "め", "も"],
  み: ["ま", "み", "む", "め", "も"],
  む: ["ま", "み", "む", "め", "も"],
  め: ["ま", "み", "む", "め", "も"],
  も: ["ま", "み", "む", "め", "も"],
  // や行
  や: ["や", "ゆ", "よ"],
  ゆ: ["や", "ゆ", "よ"],
  よ: ["や", "ゆ", "よ"],
  // ら行
  ら: ["ら", "り", "る", "れ", "ろ"],
  り: ["ら", "り", "る", "れ", "ろ"],
  る: ["ら", "り", "る", "れ", "ろ"],
  れ: ["ら", "り", "る", "れ", "ろ"],
  ろ: ["ら", "り", "る", "れ", "ろ"],
  // わ行
  わ: ["わ", "を", "ん"],
  を: ["わ", "を", "ん"],
  ん: ["わ", "を", "ん"],
};

// 拗音から基本文字へのマッピング（子音 + すべての小文字組み合わせを網羅）
export const palatalMap: Record<string, string> = {
  // あ行 + 小文字
  あぁ: "あ",
  あぃ: "あ",
  あぅ: "あ",
  あぇ: "あ",
  あぉ: "あ",
  あゃ: "あ",
  あゅ: "あ",
  あょ: "あ",
  あゎ: "あ",
  あっ: "あ",
  いぁ: "い",
  いぃ: "い",
  いぅ: "い",
  いぇ: "い",
  いぉ: "い",
  いゃ: "い",
  いゅ: "い",
  いょ: "い",
  いゎ: "い",
  いっ: "い",
  うぁ: "う",
  うぃ: "う",
  うぅ: "う",
  うぇ: "う",
  うぉ: "う",
  うゃ: "う",
  うゅ: "う",
  うょ: "う",
  うゎ: "う",
  うっ: "う",
  えぁ: "え",
  えぃ: "え",
  えぅ: "え",
  えぇ: "え",
  えぉ: "え",
  えゃ: "え",
  えゅ: "え",
  えょ: "え",
  えゎ: "え",
  えっ: "え",
  おぁ: "お",
  おぃ: "お",
  おぅ: "お",
  おぇ: "お",
  おぉ: "お",
  おゃ: "お",
  おゅ: "お",
  おょ: "お",
  おゎ: "お",
  おっ: "お",
  // か行 + 小文字
  かぁ: "か",
  かぃ: "か",
  かぅ: "か",
  かぇ: "か",
  かぉ: "か",
  かゃ: "か",
  かゅ: "か",
  かょ: "か",
  かゎ: "か",
  かっ: "か",
  きぁ: "き",
  きぃ: "き",
  きぅ: "き",
  きぇ: "き",
  きぉ: "き",
  きゃ: "き",
  きゅ: "き",
  きょ: "き",
  きゎ: "き",
  きっ: "き",
  くぁ: "く",
  くぃ: "く",
  くぅ: "く",
  くぇ: "く",
  くぉ: "く",
  くゃ: "く",
  くゅ: "く",
  くょ: "く",
  くゎ: "く",
  くっ: "く",
  けぁ: "け",
  けぃ: "け",
  けぅ: "け",
  けぇ: "け",
  けぉ: "け",
  けゃ: "け",
  けゅ: "け",
  けょ: "け",
  けゎ: "け",
  けっ: "け",
  こぁ: "こ",
  こぃ: "こ",
  こぅ: "こ",
  こぇ: "こ",
  こぉ: "こ",
  こゃ: "こ",
  こゅ: "こ",
  こょ: "こ",
  こゎ: "こ",
  こっ: "こ",
  // が行 + 小文字
  がぁ: "が",
  がぃ: "が",
  がぅ: "が",
  がぇ: "が",
  がぉ: "が",
  がゃ: "が",
  がゅ: "が",
  がょ: "が",
  がゎ: "が",
  がっ: "が",
  ぎぁ: "ぎ",
  ぎぃ: "ぎ",
  ぎぅ: "ぎ",
  ぎぇ: "ぎ",
  ぎぉ: "ぎ",
  ぎゃ: "ぎ",
  ぎゅ: "ぎ",
  ぎょ: "ぎ",
  ぎゎ: "ぎ",
  ぎっ: "ぎ",
  ぐぁ: "ぐ",
  ぐぃ: "ぐ",
  ぐぅ: "ぐ",
  ぐぇ: "ぐ",
  ぐぉ: "ぐ",
  ぐゃ: "ぐ",
  ぐゅ: "ぐ",
  ぐょ: "ぐ",
  ぐゎ: "ぐ",
  ぐっ: "ぐ",
  げぁ: "げ",
  げぃ: "げ",
  げぅ: "げ",
  げぇ: "げ",
  げぉ: "げ",
  げゃ: "げ",
  げゅ: "げ",
  げょ: "げ",
  げゎ: "げ",
  げっ: "げ",
  ごぁ: "ご",
  ごぃ: "ご",
  ごぅ: "ご",
  ごぇ: "ご",
  ごぉ: "ご",
  ごゃ: "ご",
  ごゅ: "ご",
  ごょ: "ご",
  ごゎ: "ご",
  ごっ: "ご",
  // さ行 + 小文字
  さぁ: "さ",
  さぃ: "さ",
  さぅ: "さ",
  さぇ: "さ",
  さぉ: "さ",
  さゃ: "さ",
  さゅ: "さ",
  さょ: "さ",
  さゎ: "さ",
  さっ: "さ",
  しぁ: "し",
  しぃ: "し",
  しぅ: "し",
  しぇ: "し",
  しぉ: "し",
  しゃ: "し",
  しゅ: "し",
  しょ: "し",
  しゎ: "し",
  しっ: "し",
  すぁ: "す",
  すぃ: "す",
  すぅ: "す",
  すぇ: "す",
  すぉ: "す",
  すゃ: "す",
  すゅ: "す",
  すょ: "す",
  すゎ: "す",
  すっ: "す",
  せぁ: "せ",
  せぃ: "せ",
  せぅ: "せ",
  せぇ: "せ",
  せぉ: "せ",
  せゃ: "せ",
  せゅ: "せ",
  せょ: "せ",
  せゎ: "せ",
  せっ: "せ",
  そぁ: "そ",
  そぃ: "そ",
  そぅ: "そ",
  そぇ: "そ",
  そぉ: "そ",
  そゃ: "そ",
  そゅ: "そ",
  そょ: "そ",
  そゎ: "そ",
  そっ: "そ",
  // ざ行 + 小文字
  ざぁ: "ざ",
  ざぃ: "ざ",
  ざぅ: "ざ",
  ざぇ: "ざ",
  ざぉ: "ざ",
  ざゃ: "ざ",
  ざゅ: "ざ",
  ざょ: "ざ",
  ざゎ: "ざ",
  ざっ: "ざ",
  じぁ: "じ",
  じぃ: "じ",
  じぅ: "じ",
  じぇ: "じ",
  じぉ: "じ",
  じゃ: "じ",
  じゅ: "じ",
  じょ: "じ",
  じゎ: "じ",
  じっ: "じ",
  ずぁ: "ず",
  ずぃ: "ず",
  ずぅ: "ず",
  ずぇ: "ず",
  ずぉ: "ず",
  ずゃ: "ず",
  ずゅ: "ず",
  ずょ: "ず",
  ずゎ: "ず",
  ずっ: "ず",
  ぜぁ: "ぜ",
  ぜぃ: "ぜ",
  ぜぅ: "ぜ",
  ぜぇ: "ぜ",
  ぜぉ: "ぜ",
  ぜゃ: "ぜ",
  ぜゅ: "ぜ",
  ぜょ: "ぜ",
  ぜゎ: "ぜ",
  ぜっ: "ぜ",
  ぞぁ: "ぞ",
  ぞぃ: "ぞ",
  ぞぅ: "ぞ",
  ぞぇ: "ぞ",
  ぞぉ: "ぞ",
  ぞゃ: "ぞ",
  ぞゅ: "ぞ",
  ぞょ: "ぞ",
  ぞゎ: "ぞ",
  ぞっ: "ぞ",
  // た行 + 小文字
  たぁ: "た",
  たぃ: "た",
  たぅ: "た",
  たぇ: "た",
  たぉ: "た",
  たゃ: "た",
  たゅ: "た",
  たょ: "た",
  たゎ: "た",
  たっ: "た",
  ちぁ: "ち",
  ちぃ: "ち",
  ちぅ: "ち",
  ちぇ: "ち",
  ちぉ: "ち",
  ちゃ: "ち",
  ちゅ: "ち",
  ちょ: "ち",
  ちゎ: "ち",
  ちっ: "ち",
  つぁ: "つ",
  つぃ: "つ",
  つぅ: "つ",
  つぇ: "つ",
  つぉ: "つ",
  つゃ: "つ",
  つゅ: "つ",
  つょ: "つ",
  つゎ: "つ",
  つっ: "つ",
  てぁ: "て",
  てぃ: "て",
  てぅ: "て",
  てぇ: "て",
  てぉ: "て",
  てゃ: "て",
  てゅ: "て",
  てょ: "て",
  てゎ: "て",
  てっ: "て",
  とぁ: "と",
  とぃ: "と",
  とぅ: "と",
  とぇ: "と",
  とぉ: "と",
  とゃ: "と",
  とゅ: "と",
  とょ: "と",
  とゎ: "と",
  とっ: "と",
  // だ行 + 小文字
  だぁ: "だ",
  だぃ: "だ",
  だぅ: "だ",
  だぇ: "だ",
  だぉ: "だ",
  だゃ: "だ",
  だゅ: "だ",
  だょ: "だ",
  だゎ: "だ",
  だっ: "だ",
  ぢぁ: "ぢ",
  ぢぃ: "ぢ",
  ぢぅ: "ぢ",
  ぢぇ: "ぢ",
  ぢぉ: "ぢ",
  ぢゃ: "ぢ",
  ぢゅ: "ぢ",
  ぢょ: "ぢ",
  ぢゎ: "ぢ",
  ぢっ: "ぢ",
  づぁ: "づ",
  づぃ: "づ",
  づぅ: "づ",
  づぇ: "づ",
  づぉ: "づ",
  づゃ: "づ",
  づゅ: "づ",
  づょ: "づ",
  づゎ: "づ",
  づっ: "づ",
  でぁ: "で",
  でぃ: "で",
  でぅ: "で",
  でぇ: "で",
  でぉ: "で",
  でゃ: "で",
  でゅ: "で",
  でょ: "で",
  でゎ: "で",
  でっ: "で",
  どぁ: "ど",
  どぃ: "ど",
  どぅ: "ど",
  どぇ: "ど",
  どぉ: "ど",
  どゃ: "ど",
  どゅ: "ど",
  どょ: "ど",
  どゎ: "ど",
  どっ: "ど",
  // な行 + 小文字
  なぁ: "な",
  なぃ: "な",
  なぅ: "な",
  なぇ: "な",
  なぉ: "な",
  なゃ: "な",
  なゅ: "な",
  なょ: "な",
  なゎ: "な",
  なっ: "な",
  にぁ: "に",
  にぃ: "に",
  にぅ: "に",
  にぇ: "に",
  にぉ: "に",
  にゃ: "に",
  にゅ: "に",
  にょ: "に",
  にゎ: "に",
  にっ: "に",
  ぬぁ: "ぬ",
  ぬぃ: "ぬ",
  ぬぅ: "ぬ",
  ぬぇ: "ぬ",
  ぬぉ: "ぬ",
  ぬゃ: "ぬ",
  ぬゅ: "ぬ",
  ぬょ: "ぬ",
  ぬゎ: "ぬ",
  ぬっ: "ぬ",
  ねぁ: "ね",
  ねぃ: "ね",
  ねぅ: "ね",
  ねぇ: "ね",
  ねぉ: "ね",
  ねゃ: "ね",
  ねゅ: "ね",
  ねょ: "ね",
  ねゎ: "ね",
  ねっ: "ね",
  のぁ: "の",
  のぃ: "の",
  のぅ: "の",
  のぇ: "の",
  のぉ: "の",
  のゃ: "の",
  のゅ: "の",
  のょ: "の",
  のゎ: "の",
  のっ: "の",
  // は行 + 小文字
  はぁ: "は",
  はぃ: "は",
  はぅ: "は",
  はぇ: "は",
  はぉ: "は",
  はゃ: "は",
  はゅ: "は",
  はょ: "は",
  はゎ: "は",
  はっ: "は",
  ひぁ: "ひ",
  ひぃ: "ひ",
  ひぅ: "ひ",
  ひぇ: "ひ",
  ひぉ: "ひ",
  ひゃ: "ひ",
  ひゅ: "ひ",
  ひょ: "ひ",
  ひゎ: "ひ",
  ひっ: "ひ",
  ふぁ: "ふ",
  ふぃ: "ふ",
  ふぅ: "ふ",
  ふぇ: "ふ",
  ふぉ: "ふ",
  ふゃ: "ふ",
  ふゅ: "ふ",
  ふょ: "ふ",
  ふゎ: "ふ",
  ふっ: "ふ",
  へぁ: "へ",
  へぃ: "へ",
  へぅ: "へ",
  へぇ: "へ",
  へぉ: "へ",
  へゃ: "へ",
  へゅ: "へ",
  へょ: "へ",
  へゎ: "へ",
  へっ: "へ",
  ほぁ: "ほ",
  ほぃ: "ほ",
  ほぅ: "ほ",
  ほぇ: "ほ",
  ほぉ: "ほ",
  ほゃ: "ほ",
  ほゅ: "ほ",
  ほょ: "ほ",
  ほゎ: "ほ",
  ほっ: "ほ",
  // ば行 + 小文字
  ばぁ: "ば",
  ばぃ: "ば",
  ばぅ: "ば",
  ばぇ: "ば",
  ばぉ: "ば",
  ばゃ: "ば",
  ばゅ: "ば",
  ばょ: "ば",
  ばゎ: "ば",
  ばっ: "ば",
  びぁ: "び",
  びぃ: "び",
  びぅ: "び",
  びぇ: "び",
  びぉ: "び",
  びゃ: "び",
  びゅ: "び",
  びょ: "び",
  びゎ: "び",
  びっ: "び",
  ぶぁ: "ぶ",
  ぶぃ: "ぶ",
  ぶぅ: "ぶ",
  ぶぇ: "ぶ",
  ぶぉ: "ぶ",
  ぶゃ: "ぶ",
  ぶゅ: "ぶ",
  ぶょ: "ぶ",
  ぶゎ: "ぶ",
  ぶっ: "ぶ",
  べぁ: "べ",
  べぃ: "べ",
  べぅ: "べ",
  べぇ: "べ",
  べぉ: "べ",
  べゃ: "べ",
  べゅ: "べ",
  べょ: "べ",
  べゎ: "べ",
  べっ: "べ",
  ぼぁ: "ぼ",
  ぼぃ: "ぼ",
  ぼぅ: "ぼ",
  ぼぇ: "ぼ",
  ぼぉ: "ぼ",
  ぼゃ: "ぼ",
  ぼゅ: "ぼ",
  ぼょ: "ぼ",
  ぼゎ: "ぼ",
  ぼっ: "ぼ",
  // ぱ行 + 小文字
  ぱぁ: "ぱ",
  ぱぃ: "ぱ",
  ぱぅ: "ぱ",
  ぱぇ: "ぱ",
  ぱぉ: "ぱ",
  ぱゃ: "ぱ",
  ぱゅ: "ぱ",
  ぱょ: "ぱ",
  ぱゎ: "ぱ",
  ぱっ: "ぱ",
  ぴぁ: "ぴ",
  ぴぃ: "ぴ",
  ぴぅ: "ぴ",
  ぴぇ: "ぴ",
  ぴぉ: "ぴ",
  ぴゃ: "ぴ",
  ぴゅ: "ぴ",
  ぴょ: "ぴ",
  ぴゎ: "ぴ",
  ぴっ: "ぴ",
  ぷぁ: "ぷ",
  ぷぃ: "ぷ",
  ぷぅ: "ぷ",
  ぷぇ: "ぷ",
  ぷぉ: "ぷ",
  ぷゃ: "ぷ",
  ぷゅ: "ぷ",
  ぷょ: "ぷ",
  ぷゎ: "ぷ",
  ぷっ: "ぷ",
  ぺぁ: "ぺ",
  ぺぃ: "ぺ",
  ぺぅ: "ぺ",
  ぺぇ: "ぺ",
  ぺぉ: "ぺ",
  ぺゃ: "ぺ",
  ぺゅ: "ぺ",
  ぺょ: "ぺ",
  ぺゎ: "ぺ",
  ぺっ: "ぺ",
  ぽぁ: "ぽ",
  ぽぃ: "ぽ",
  ぽぅ: "ぽ",
  ぽぇ: "ぽ",
  ぽぉ: "ぽ",
  ぽゃ: "ぽ",
  ぽゅ: "ぽ",
  ぽょ: "ぽ",
  ぽゎ: "ぽ",
  ぽっ: "ぽ",
  // ま行 + 小文字
  まぁ: "ま",
  まぃ: "ま",
  まぅ: "ま",
  まぇ: "ま",
  まぉ: "ま",
  まゃ: "ま",
  まゅ: "ま",
  まょ: "ま",
  まゎ: "ま",
  まっ: "ま",
  みぁ: "み",
  みぃ: "み",
  みぅ: "み",
  みぇ: "み",
  みぉ: "み",
  みゃ: "み",
  みゅ: "み",
  みょ: "み",
  みゎ: "み",
  みっ: "み",
  むぁ: "む",
  むぃ: "む",
  むぅ: "む",
  むぇ: "む",
  むぉ: "む",
  むゃ: "む",
  むゅ: "む",
  むょ: "む",
  むゎ: "む",
  むっ: "む",
  めぁ: "め",
  めぃ: "め",
  めぅ: "め",
  めぇ: "め",
  めぉ: "め",
  めゃ: "め",
  めゅ: "め",
  めょ: "め",
  めゎ: "め",
  めっ: "め",
  もぁ: "も",
  もぃ: "も",
  もぅ: "も",
  もぇ: "も",
  もぉ: "も",
  もゃ: "も",
  もゅ: "も",
  もょ: "も",
  もゎ: "も",
  もっ: "も",
  // や行 + 小文字
  やぁ: "や",
  やぃ: "や",
  やぅ: "や",
  やぇ: "や",
  やぉ: "や",
  やゃ: "や",
  やゅ: "や",
  やょ: "や",
  やゎ: "や",
  やっ: "や",
  ゆぁ: "ゆ",
  ゆぃ: "ゆ",
  ゆぅ: "ゆ",
  ゆぇ: "ゆ",
  ゆぉ: "ゆ",
  ゆゃ: "ゆ",
  ゆゅ: "ゆ",
  ゆょ: "ゆ",
  ゆゎ: "ゆ",
  ゆっ: "ゆ",
  よぁ: "よ",
  よぃ: "よ",
  よぅ: "よ",
  よぇ: "よ",
  よぉ: "よ",
  よゃ: "よ",
  よゅ: "よ",
  よょ: "よ",
  よゎ: "よ",
  よっ: "よ",
  // ら行 + 小文字
  らぁ: "ら",
  らぃ: "ら",
  らぅ: "ら",
  らぇ: "ら",
  らぉ: "ら",
  らゃ: "ら",
  らゅ: "ら",
  らょ: "ら",
  らゎ: "ら",
  らっ: "ら",
  りぁ: "り",
  りぃ: "り",
  りぅ: "り",
  りぇ: "り",
  りぉ: "り",
  りゃ: "り",
  りゅ: "り",
  りょ: "り",
  りゎ: "り",
  りっ: "り",
  るぁ: "る",
  るぃ: "る",
  るぅ: "る",
  るぇ: "る",
  るぉ: "る",
  るゃ: "る",
  るゅ: "る",
  るょ: "る",
  るゎ: "る",
  るっ: "る",
  れぁ: "れ",
  れぃ: "れ",
  れぅ: "れ",
  れぇ: "れ",
  れぉ: "れ",
  れゃ: "れ",
  れゅ: "れ",
  れょ: "れ",
  れゎ: "れ",
  れっ: "れ",
  ろぁ: "ろ",
  ろぃ: "ろ",
  ろぅ: "ろ",
  ろぇ: "ろ",
  ろぉ: "ろ",
  ろゃ: "ろ",
  ろゅ: "ろ",
  ろょ: "ろ",
  ろゎ: "ろ",
  ろっ: "ろ",
  // わ行 + 小文字
  わぁ: "わ",
  わぃ: "わ",
  わぅ: "わ",
  わぇ: "わ",
  わぉ: "わ",
  わゃ: "わ",
  わゅ: "わ",
  わょ: "わ",
  わゎ: "わ",
  わっ: "わ",
  をぁ: "を",
  をぃ: "を",
  をぅ: "を",
  をぇ: "を",
  をぉ: "を",
  をゃ: "を",
  をゅ: "を",
  をょ: "を",
  をゎ: "を",
  をっ: "を",
  んぁ: "ん",
  んぃ: "ん",
  んぅ: "ん",
  んぇ: "ん",
  んぉ: "ん",
  んゃ: "ん",
  んゅ: "ん",
  んょ: "ん",
  んゎ: "ん",
  んっ: "ん",
  // ゔ + 小文字
  ゔぁ: "ゔ",
  ゔぃ: "ゔ",
  ゔぅ: "ゔ",
  ゔぇ: "ゔ",
  ゔぉ: "ゔ",
  ゔゃ: "ゔ",
  ゔゅ: "ゔ",
  ゔょ: "ゔ",
  ゔゎ: "ゔ",
  ゔっ: "ゔ",
};

/**
 * Simple predictable PRNG (Mulberry32)
 */
export function createPRNG(seed: number) {
  return function () {
    let t = (seed += 0x6d2b79f5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

/**
 * Difficulty-based word selection logic (Shared)
 */
export function getNextWordSeeded(
  activeList: Word[],
  elapsedTime: number,
  prng: () => number
) {
  const DIFFICULTY_THRESHOLDS = [20, 40, 60];
  const WORD_LENGTHS = {
    LEVEL1: { min: 1, max: 3 },
    LEVEL2: { min: 3, max: 5 },
    LEVEL3: { min: 4, max: 6 },
    LEVEL4: { min: 5, max: 20 },
  };

  let min: number, max: number;
  if (elapsedTime < DIFFICULTY_THRESHOLDS[0])
    ({ min, max } = WORD_LENGTHS.LEVEL1);
  else if (elapsedTime < DIFFICULTY_THRESHOLDS[1])
    ({ min, max } = WORD_LENGTHS.LEVEL2);
  else if (elapsedTime < DIFFICULTY_THRESHOLDS[2])
    ({ min, max } = WORD_LENGTHS.LEVEL3);
  else ({ min, max } = WORD_LENGTHS.LEVEL4);

  let candidates = activeList.filter(
    (w) => w.kana.length >= min && w.kana.length <= max
  );
  if (candidates.length === 0) candidates = activeList;
  if (candidates.length === 0) return { disp: "NO DATA", kana: "nodata" };

  return candidates[Math.floor(prng() * candidates.length)];
}

export const KanaEngine: {
  table: KanaTable;
  tokenize(kanaWord: string): string[];
  getValidPatterns(token: string, nextToken?: string): string[];
} = {
  table: (function () {
    return {
      あ: ["a"],
      い: ["i", "yi"],
      う: ["u", "wu", "whu"],
      え: ["e"],
      お: ["o"],
      か: ["ka", "ca"],
      き: ["ki"],
      く: ["ku", "cu", "qu"],
      け: ["ke"],
      こ: ["ko", "co"],
      さ: ["sa"],
      し: ["shi", "si", "ci"],
      す: ["su"],
      せ: ["se", "ce"],
      そ: ["so"],
      た: ["ta"],
      ち: ["chi", "ti"],
      つ: ["tsu", "tu"],
      て: ["te"],
      と: ["to"],
      な: ["na"],
      に: ["ni"],
      ぬ: ["nu"],
      ね: ["ne"],
      の: ["no"],
      は: ["ha"],
      ひ: ["hi"],
      ふ: ["fu", "hu"],
      へ: ["he"],
      ほ: ["ho"],
      ま: ["ma"],
      み: ["mi"],
      む: ["mu"],
      め: ["me"],
      も: ["mo"],
      や: ["ya"],
      ゆ: ["yu"],
      よ: ["yo"],
      ら: ["ra"],
      り: ["ri"],
      る: ["ru"],
      れ: ["re"],
      ろ: ["ro"],
      わ: ["wa"],
      を: ["wo"],
      ん: ["nn", "xn", "n"],
      が: ["ga"],
      ぎ: ["gi"],
      ぐ: ["gu"],
      げ: ["ge"],
      ご: ["go"],
      ざ: ["za"],
      じ: ["ji", "zi"],
      ず: ["zu"],
      ぜ: ["ze"],
      ぞ: ["zo"],
      だ: ["da"],
      ぢ: ["ji", "di"],
      づ: ["zu", "du"],
      で: ["de"],
      ど: ["do"],
      ば: ["ba"],
      び: ["bi"],
      ぶ: ["bu"],
      べ: ["be"],
      ぼ: ["bo"],
      ぱ: ["pa"],
      ぴ: ["pi"],
      ぷ: ["pu"],
      ぺ: ["pe"],
      ぽ: ["po"],
      ぁ: ["xa", "la"],
      ぃ: ["xi", "li"],
      ぅ: ["xu", "lu"],
      ぇ: ["xe", "le"],
      ぉ: ["xo", "lo"],
      っ: ["xtu", "ltu", "tsu"],
      ゃ: ["xya", "lya"],
      ゅ: ["xyu", "lyu"],
      ょ: ["xyo", "lyo"],
      ゎ: ["xwa", "lwa"],
      きゃ: ["kya", "kixya"],
      きゅ: ["kyu", "kixyu"],
      きょ: ["kyo", "kixyo"],
      しゃ: ["sha", "sya"],
      しゅ: ["shu", "syu"],
      しょ: ["sho", "syo"],
      ちゃ: ["cha", "tya"],
      ちゅ: ["chu", "tyu"],
      ちょ: ["cho", "tyo"],
      にゃ: ["nya"],
      にゅ: ["nyu"],
      にょ: ["nyo"],
      ひゃ: ["hya"],
      ひゅ: ["hyu"],
      ひょ: ["hyo"],
      みゃ: ["mya"],
      みゅ: ["myu"],
      みょ: ["myo"],
      りゃ: ["rya"],
      りゅ: ["ryu"],
      りょ: ["ryo"],
      ぎゃ: ["gya"],
      ぎゅ: ["gyu"],
      ぎょ: ["gyo"],
      じゃ: ["ja", "jya", "zya"],
      じゅ: ["ju", "jyu", "zyu"],
      じょ: ["jo", "jyo", "zyo"],
      びゃ: ["bya"],
      びゅ: ["byu"],
      びょ: ["byo"],
      ぴゃ: ["pya"],
      ぴゅ: ["pyu"],
      ぴょ: ["pyo"],
      いェ: ["ye"],
      うぁ: ["wha"],
      うぃ: ["wi", "whi"],
      うぇ: ["we", "whe"],
      うぉ: ["who"],
      ヴ: ["vu"],
      ゔ: ["vu"],
      ゔぁ: ["va"],
      ゔぃ: ["vi"],
      ゔぇ: ["ve"],
      ゔぉ: ["vo"],
      くぁ: ["qa", "qwa", "kwa"],
      ぐぁ: ["gwa"],
      しェ: ["she", "sye"],
      じェ: ["je", "jye"],
      ちェ: ["che", "tye"],
      つぁ: ["tsa"],
      つぃ: ["tsi"],
      つぇ: ["tse"],
      つぉ: ["tso"],
      てぃ: ["thi"],
      てゅ: ["thu"],
      でぃ: ["dhi"],
      でゅ: ["dhu"],
      とぅ: ["twu", "toxu"],
      どぅ: ["dwu", "doxu"],
      ふぁ: ["fa"],
      ふぃ: ["fi"],
      ふぇ: ["fe"],
      ふぉ: ["fo"],
      ふゅ: ["fyu"],
    };
  })(),

  tokenize(kanaWord: string) {
    const tokens: string[] = [];
    for (let i = 0; i < kanaWord.length; i++) {
      const char = kanaWord[i];
      const next = kanaWord[i + 1];
      if (
        next &&
        ["ゃ", "ゅ", "ょ", "ぁ", "ぃ", "ぅ", "ぇ", "ぉ", "ゎ"].includes(next)
      ) {
        tokens.push(char + next);
        i++;
      } else {
        tokens.push(char);
      }
    }
    return tokens;
  },

  getValidPatterns(token: string, nextToken?: string) {
    let patterns: string[] = [...(this.table[token] || [])];

    if (token.length === 2 && token.charAt(0) !== "っ") {
      const char1 = token.charAt(0);
      const char2 = token.charAt(1);
      const p1List = this.table[char1] || [];
      const p2List = this.table[char2] || [];
      for (const p1 of p1List) {
        for (const p2 of p2List) patterns.push(p1 + p2);
      }
    }

    if (token === "っ" && nextToken) {
      const nextBasicPatterns = this.table[nextToken] || [];
      if (nextBasicPatterns.length > 0) {
        const consonants = new Set<string>();
        for (const p of nextBasicPatterns) {
          if (p.length > 0) consonants.add(p[0]);
        }
        patterns = [...consonants, ...patterns];
      }
    }
    return patterns;
  },
};

// Parse CSV text and return words + validation errors (reusable on server and client)
export function parseWords(text: string): { words: Word[]; errors: string[] } {
  const lines = text.split(/\r\n|\n/);
  const words: Word[] = [];
  const errors: string[] = [];

  for (let i = 0; i < lines.length; i++) {
    const raw = lines[i];
    const lineNo = i + 1;
    if (!raw.trim()) continue;
    const parts = raw.split(",");

    // Allow and skip a header row if it appears to be ASCII labels
    if (
      i === 0 &&
      parts.length >= 2 &&
      /[A-Za-z]/.test(parts[0]) &&
      /[A-Za-z]/.test(parts[1])
    ) {
      continue; // skip header
    }

    if (parts.length < 2) {
      errors.push(`Line ${lineNo}: missing columns`);
      continue;
    }

    const disp = parts[0].trim();
    const kana = parts[1].trim();
    if (!disp || !kana) {
      errors.push(`Line ${lineNo}: empty display or kana`);
      continue;
    }

    const tokens = KanaEngine.tokenize(kana);
    let valid = true;
    for (const t of tokens) {
      if (!KanaEngine.table[t]) {
        valid = false;
        break;
      }
    }
    if (!valid) {
      errors.push(`Line ${lineNo}: invalid kana '${kana}'`);
      continue;
    }

    words.push({ disp, kana });
  }

  return { words, errors };
}
